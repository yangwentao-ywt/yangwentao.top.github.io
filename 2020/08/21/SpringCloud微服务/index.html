

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/yangwentao-ywt.github.io/img/favicon.png">
  <link rel="icon" type="image/png" href="/yangwentao-ywt.github.io/img/avatar.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  <title>hello</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/yangwentao-ywt.github.io/lib/hint/hint.min.css" />

  
    
    <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/github-gist.min.css" />
  

  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_6peoq002giu.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_pjno9b9zyxs.css">


<link  rel="stylesheet" href="/yangwentao-ywt.github.io/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script  src="/yangwentao-ywt.github.io/js/utils.js" ></script>
  <script  src="/yangwentao-ywt.github.io/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.0.2"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/yangwentao-ywt.github.io/">&nbsp;<strong>hello</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/yangwentao-ywt.github.io/">
                <i class="iconfont icon-home-fill"></i>
                主页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/yangwentao-ywt.github.io/archives/">
                <i class="iconfont icon-archive-fill"></i>
                档案
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/yangwentao-ywt.github.io/categories/">
                <i class="iconfont icon-category-fill"></i>
                目录
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/yangwentao-ywt.github.io/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/yangwentao-ywt.github.io/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('/yangwentao-ywt.github.io/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container page-header text-center fade-in-up">
            <span class="h2" id="subtitle">
              
            </span>

            
              
  <div class="mt-3 post-meta">
    <i class="iconfont icon-date-fill" aria-hidden="true"></i>
    <time datetime="2020-08-21 09:33" pubdate>
      August 21, 2020 am
    </time>
  </div>


<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      3.1k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      40
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto" id="post">
            <!-- SEO header -->
            <h1 style="display: none"></h1>
            
            <div class="markdown-body" id="post-body">
              <h1 id="SpringCloud微服务"><a href="#SpringCloud微服务" class="headerlink" title="SpringCloud微服务"></a>SpringCloud微服务</h1><h3 id="一-SpringCloud"><a href="#一-SpringCloud" class="headerlink" title="一.SpringCloud"></a>一.SpringCloud</h3><blockquote>
<p>Spring Cloud是一系列框架的有序集合。它利用Spring Boot的开发便利性巧妙地简化了分布式系统基础设施的开发，如服务发现注册、配置中心、智能路由、消息总线、负载均衡、断路器、数据监控等。Spring Cloud 并不重复造轮子，而是将市面上开发得比较好的模块集成进去，进行封装，从而减少了各模块的开发成本。</p>
</blockquote>
<h3 id="二-SpringCloud的基础功能"><a href="#二-SpringCloud的基础功能" class="headerlink" title="二.SpringCloud的基础功能"></a>二.SpringCloud的基础功能</h3><ul>
<li>服务发现：Netflix Eureka</li>
<li>客户端负载均衡：Netflix Ribbon</li>
<li>断路器：Netflix Hystrix</li>
<li>服务网关：Netflix Zuul</li>
<li>声明式服务调用”Feign</li>
<li>分布式配置：Spring Cloud Config</li>
</ul>
<h3 id="三-SpringCloud引入Eureka"><a href="#三-SpringCloud引入Eureka" class="headerlink" title="三.SpringCloud引入Eureka"></a>三.SpringCloud引入Eureka</h3><blockquote>
<p>Spirng Cloud Eureka使用Netflix Eureka来实现服务注册与发现，由两个组件组成：Eureka服务端(Eureka Service)和Eureka客户端(Eureka Client)。而Eureka Client又分为服务提供者和服务消费者。</p>
</blockquote>
<ol>
<li><p>在项目中加入Eureka服务中心的依赖</p>
<pre><code class="hljs xml"><span class="hljs-comment">&lt;!--  Eureka服务中心  --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre>
</li>
<li><p>写yml配置文件</p>
<pre><code class="hljs yaml"><span class="hljs-attr">server:</span>
<span class="hljs-attr">port:</span> <span class="hljs-number">7070</span>
<span class="hljs-attr">spring:</span>
<span class="hljs-attr">application:</span>
 <span class="hljs-attr">name:</span> <span class="hljs-string">eureka-service</span>
<span class="hljs-attr">eureka:</span>
<span class="hljs-attr">client:</span>
 <span class="hljs-attr">service-url:</span>
     <span class="hljs-comment">#该注册中心指向另一个注册中心 互相注册。可配置多个 使用“,”分割</span>
   <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://127.0.0.1:7070/eureka</span> 
   <span class="hljs-comment">#是否检索服务</span>
   <span class="hljs-attr">fetch-registry:</span> <span class="hljs-literal">false</span> 
   <span class="hljs-comment">#是否向服务注册中心注册自己</span>
   <span class="hljs-attr">register-with-eureka:</span> <span class="hljs-literal">false</span> 
<span class="hljs-attr">instance:</span>
 <span class="hljs-comment">#开启后显示服务器地址</span>
 <span class="hljs-attr">prefer-ip-address:</span> <span class="hljs-literal">true</span>
 <span class="hljs-attr">ip-address:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span></code></pre>
</li>
<li><p>在主启动类上加注解</p>
<pre><code class="hljs less"><span class="hljs-variable">@SpringBootApplication</span>
<span class="hljs-variable">@EnableEurekaServer</span> <span class="hljs-comment">//将项目作为SpringCloud中的注册中心</span>
public class EurekaMain7070 &#123;
 <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">static</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">main</span>(String[] args) &#123;
     <span class="hljs-selector-tag">SpringApplication</span><span class="hljs-selector-class">.run</span>(EurekaMain7070.class,args);
 &#125;
&#125;</code></pre>
</li>
<li><p>将其他服务注册到Eureka注册中心</p>
<pre><code class="hljs xml"><span class="hljs-comment">&lt;!--  Eureka客户中心  --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre>

<pre><code class="hljs yaml"><span class="hljs-attr">server:</span>
<span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>
<span class="hljs-attr">spring:</span>
<span class="hljs-attr">application:</span>
 <span class="hljs-attr">name:</span> <span class="hljs-string">user-service</span>
<span class="hljs-attr">eureka:</span>
<span class="hljs-attr">client:</span>
   <span class="hljs-comment">#表示向注册中心注册自己 默认为true</span>
 <span class="hljs-attr">register-with-eureka:</span> <span class="hljs-literal">true</span> 
 <span class="hljs-comment">#是否从EurekaServer抓取已有的注册信息，默认为true,单节点无所谓,集群必须设置为true才能配合ribbon使用        负载均衡</span>
 <span class="hljs-attr">fetch-registry:</span> <span class="hljs-literal">true</span> 
 <span class="hljs-attr">service-url:</span>
   <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://127.0.0.1:7070/eureka</span> <span class="hljs-comment">#入驻地址</span></code></pre>

<pre><code class="hljs less"><span class="hljs-variable">@SpringBootApplication</span>
<span class="hljs-variable">@EnableEurekaClient</span>  <span class="hljs-comment">//让注册中心能够发现</span>
public class UserMain8080 &#123;
 <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">static</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">main</span>(String[] args) &#123;
     <span class="hljs-selector-tag">SpringApplication</span><span class="hljs-selector-class">.run</span>(UserMain8080.class,args);
 &#125;
&#125;</code></pre>

</li>
</ol>
<p><strong>3.1 Eureka的治理机制</strong></p>
<ol>
<li>服务提供者<ul>
<li><strong>服务注册：</strong>启动的时候会通过发送REST请求的方式将自己注册到Eureka Server上，同时带上了自身服务的一些元数据信息</li>
<li><strong>服务续约：</strong>在注册完服务之后，服务提供者会维护一个心跳用来持续告诉Eureka Server: “我还活着 ” </li>
<li><strong>服务下线：</strong>当服务实例进行正常的关闭操作时，它会触发一个服务下线的REST请求给Eureka Server, 告诉服务注册中心：“我要下线了 ”</li>
</ul>
</li>
<li>服务消费者<ul>
<li><strong>获取服务：</strong>当我们启动服务消费者的时候，它会发送一个REST请求给服务注册中心，来获取上面注册的服务清单</li>
<li><strong>服务调用：</strong>服务消费者在获取服务清单后，通过服务名可以获得具体提供服务的实例名和该实例的元数据信息。在进行服务调用的时候，优先访问同处一个Zone中的服务提供方。</li>
</ul>
</li>
<li>服务注册中心<ul>
<li><strong>失效剔除：</strong>默认每隔一段时间（默认为60秒） 将当前清单中超时（默认为90秒）没有续约的服务剔除出去</li>
<li><strong>自我保护：</strong>EurekaServer 在运行期间，会统计心跳失败的比例在15分钟之内是否低于85%(通常由于网络不稳定导致)。 Eureka Server会将当前的实例注册信息保护起来， 让这些实例不会过期，尽可能保护这些注册信息</li>
</ul>
</li>
</ol>
<h3 id="四-SpringCloud引入Ribbon"><a href="#四-SpringCloud引入Ribbon" class="headerlink" title="四.SpringCloud引入Ribbon"></a>四.SpringCloud引入Ribbon</h3><blockquote>
<p>Ribbon 是一个基于Http和TCP的客服端负载均衡工具，它是基于Netflix Ribbon实现的。它不像spring cloud服务注册中心、配置中心、API网关那样独立部署，但是它几乎存在于每个spring cloud 微服务中。包括feign提供的声明式服务调用也是基于该Ribbon实现的。ribbon提供很多种负载均衡算法（默认的负载均衡策略是轮询），例如 轮询、随机、最少并发策略等等。甚至包含自定义的负载均衡算法。</p>
</blockquote>
<ol>
<li><p>在项目中加入Ribbon依赖</p>
<pre><code class="hljs xml"> <span class="hljs-comment">&lt;!--  ribbon负载均衡  --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-ribbon<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre>
</li>
<li><p>在yml配置文件中配置Ribbon负载均衡策略</p>
<pre><code class="hljs css"><span class="hljs-selector-tag">provider-service</span>:
<span class="hljs-selector-tag">ribbon</span>:
 <span class="hljs-selector-tag">NFLoadBalancerRuleClassName</span>: <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.netflix</span><span class="hljs-selector-class">.loadbalancer</span><span class="hljs-selector-class">.RandomRule</span></code></pre>
</li>
<li><p>在主启动类开启负载均衡</p>
<pre><code class="hljs less"><span class="hljs-variable">@Bean</span>
<span class="hljs-variable">@LoadBalanced</span>
public RestTemplate getRestTemplate()&#123;
<span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">RestTemplate</span>();
&#125;</code></pre>
</li>
<li><p>进行测试</p>
<pre><code class="hljs less"><span class="hljs-variable">@RestController</span>
<span class="hljs-variable">@RequestMapping</span>(<span class="hljs-string">&quot;user&quot;</span>)
public class UserController &#123;
<span class="hljs-variable">@Resource</span>
private UserService userService;
<span class="hljs-variable">@GetMapping</span>(<span class="hljs-string">&quot;getUserById/&#123;id&#125;&quot;</span>)
 public User getUserById(<span class="hljs-variable">@PathVariable</span>(<span class="hljs-string">&quot;id&quot;</span>) Integer id)&#123;
     <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">userService</span><span class="hljs-selector-class">.getUserById</span>(id);
 &#125;
&#125;</code></pre>

<pre><code class="hljs aspectj"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserService</span> </span>&#123;
 <span class="hljs-meta">@Resource</span>
 <span class="hljs-keyword">private</span> RestTemplate restTemplate;
 <span class="hljs-meta">@Override</span>
 <span class="hljs-keyword">public</span> <span class="hljs-function">User <span class="hljs-title">getUserById</span><span class="hljs-params">(Integer id)</span> </span>&#123;
    String url = <span class="hljs-string">&quot;http://provider-service/user/getUserById/&quot;</span>;
    <span class="hljs-function"><span class="hljs-keyword">return</span> restTemplate.<span class="hljs-title">getForObject</span><span class="hljs-params">(url+id,User.class)</span></span>;
 &#125;
&#125;</code></pre>

<p>多次刷新看到调用的端口在来回切换则成功实现负载均衡</p>
</li>
</ol>
<h3 id="五-SpringCloud引入Hystrix"><a href="#五-SpringCloud引入Hystrix" class="headerlink" title="五.SpringCloud引入Hystrix"></a>五.SpringCloud引入Hystrix</h3><blockquote>
<p>在高并发的情况下，由于单个服务的延迟，可能导致所有的请求都处于延迟状态，甚至在几秒钟就使服务处于负载饱和的状态，资源耗尽，直到不可用，最终导致这个分布式系统都不可用，这就是“雪崩”。Hystrix断路器可以防止一个应用程序多次试图执行一个操作，当某个服务单元发生故障（类似用电器发生短路）之后，通过断路器的故障监控（类似熔断保险丝）， 向调用方返回一个错误响应， 而不是长时间的等待。这样就不会使得线程因调用故障服务被长时间占用不释放，避免了故障在分布式系统中的蔓延</p>
</blockquote>
<ol>
<li><p>在消费者pom中加入Hystrix的依赖包</p>
<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre>
</li>
<li><p>在主启动类加入注解</p>
<pre><code class="hljs aspectj"><span class="hljs-meta">@EnableHystrix</span></code></pre>
</li>
<li><p>测试是否生效</p>
<p>&lt;!–hexoPostRenderEscape:<pre><code class="hljs pgsql">@Override<br>@HystrixCommand(fallbackMethod = &quot;queryUserByIdFallback&quot;,  //失败后的回调函数<br>//每十次请求中失败率达到百分之三十则开启熔断，此时再调用该服务，则直接返回失败，直到十秒后重新检测该触发条件，判断是否把熔断器打开或者继续关闭</p>
<pre><code>         commandProperties = &amp;#123;
         @HystrixProperty(&lt;span class=&quot;hljs-type&quot;&gt;name&lt;/span&gt;=&amp;quot;circuitBreaker.requestVolumeThreshold&amp;quot; ,&lt;span class=&quot;hljs-keyword&quot;&gt;value&lt;/span&gt;=&amp;quot;10&amp;quot;),
         @HystrixProperty(&lt;span class=&quot;hljs-type&quot;&gt;name&lt;/span&gt;=&amp;quot;circuitBreaker.sleepWindowInMilliseconds&amp;quot; ,&lt;span class=&quot;hljs-keyword&quot;&gt;value&lt;/span&gt;=&amp;quot;10000&amp;quot;),
         @HystrixProperty(&lt;span class=&quot;hljs-type&quot;&gt;name&lt;/span&gt;=&amp;quot;circuitBreaker.errorThresholdPercentage&amp;quot; ,&lt;span class=&quot;hljs-keyword&quot;&gt;value&lt;/span&gt;=&amp;quot;30&amp;quot;)
 &amp;#125;)</code></pre>
<p><span class="hljs-built_in">public</span> <span class="hljs-keyword">User</span> queryUserById(<span class="hljs-type">Integer</span> id) &#123;<br> long <span class="hljs-keyword">begin</span> = <span class="hljs-keyword">System</span>.currentTimeMillis();<br> <span class="hljs-keyword">User</span> <span class="hljs-keyword">user</span>= restTemplate.getForObject(url+id, <span class="hljs-keyword">User</span>.<span class="hljs-keyword">class</span>);<br> long end = <span class="hljs-keyword">System</span>.currentTimeMillis();<br> logger.<span class="hljs-keyword">info</span>(&quot;访问用时&#123;&#125;&quot;,<span class="hljs-keyword">end</span>-<span class="hljs-keyword">begin</span>);<br> <span class="hljs-keyword">return</span> <span class="hljs-keyword">user</span>;<br>&#125;</p>
</li>
</ol>
<p>private <span class="hljs-keyword">User</span> queryUserByIdFallback(<span class="hljs-type">Integer</span> id)&#123;<br>    <span class="hljs-keyword">User</span> <span class="hljs-keyword">user</span> = <span class="hljs-built_in">new</span> <span class="hljs-keyword">User</span>();<br>    <span class="hljs-keyword">user</span>.setId(id);<br>    <span class="hljs-keyword">user</span>.setUserCode(&quot;查询用户信息出现异常&quot;);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">user</span>;<br>&#125;</code></pre>:hexoPostRenderEscape–&gt;</p>
<h3 id="六-SpringCloud引入Feign"><a href="#六-SpringCloud引入Feign" class="headerlink" title="六.SpringCloud引入Feign"></a>六.SpringCloud引入Feign</h3><blockquote>
<p>Feign是一种声明式、模板化的HTTP客户端。在Spring Cloud中使用Feign, 我们可以做到使用HTTP请求远程服务时能与调用本地方法一样的编码体验，开发者完全感知不到这是远程方法，更感知不到这是个HTTP请求。</p>
</blockquote>
<ol>
<li><p>在服务调用者pom加入Feign依赖</p>
<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre>
</li>
<li><p>在yml写配置文件</p>
<pre><code class="hljs yaml"><span class="hljs-attr">feign:</span>
<span class="hljs-attr">hystrix:</span>
 <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>  <span class="hljs-comment">#开启Feign Hystrix 支持</span>
<span class="hljs-attr">httpclient:</span>
 <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span> <span class="hljs-comment">#关闭httpclient</span>
<span class="hljs-attr">okhttp:</span>
 <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>  <span class="hljs-comment">#开启okHttp</span></code></pre>
</li>
<li><p>在主启动类加入注解</p>
<pre><code class="hljs aspectj"><span class="hljs-meta">@EnableFeignClients</span></code></pre>
</li>
<li><p>使用Feign实现远程调用</p>
<pre><code class="hljs less"><span class="hljs-comment">/**</span>
<span class="hljs-comment">* value:指定调用哪个服务</span>
<span class="hljs-comment">* fallbackFactory:熔断器的降级提示</span>
<span class="hljs-comment">*/</span>
<span class="hljs-variable">@FeignClient</span>(value = <span class="hljs-string">&quot;provider-service&quot;</span>,fallback = UserFeignClientFallback.class)
public interface UserFeignClient &#123;
 <span class="hljs-comment">//采用Feign我们可以使用SpringMVC的注解来对服务进行绑定！</span>
 <span class="hljs-variable">@GetMapping</span>(<span class="hljs-string">&quot;/user/getUserById/&#123;id&#125;&quot;</span>)
 User userFeign(<span class="hljs-variable">@PathVariable</span>(<span class="hljs-string">&quot;id&quot;</span>) Integer id);
&#125;</code></pre>

<pre><code class="hljs pgsql"><span class="hljs-comment">/**</span>
<span class="hljs-comment"> * Feign中使用断路器</span>
<span class="hljs-comment"> * 这里主要是处理异常出错的情况(降级/熔断时服务不可用，fallback就会找到这里来)</span>
<span class="hljs-comment"> */</span>
@Component
<span class="hljs-built_in">public</span> <span class="hljs-keyword">class</span> UserFeignClientFallback implements UserFeignClient &#123;
 @Override
 <span class="hljs-built_in">public</span> <span class="hljs-keyword">User</span> userFeign(<span class="hljs-type">Integer</span> id) &#123;
     <span class="hljs-keyword">User</span> <span class="hljs-keyword">user</span> = <span class="hljs-built_in">new</span> <span class="hljs-keyword">User</span>();
     <span class="hljs-keyword">user</span>.setId(id);
     <span class="hljs-keyword">user</span>.setUserCode(&quot;查询用户信息出现异常&quot;);
     <span class="hljs-keyword">return</span> <span class="hljs-keyword">user</span>;
 &#125;
&#125;</code></pre>

<pre><code class="hljs less"><span class="hljs-variable">@RestController</span>
<span class="hljs-variable">@RequestMapping</span>(<span class="hljs-string">&quot;user&quot;</span>)
public class UserController &#123;
 <span class="hljs-variable">@Resource</span>
 private UserFeignClient userFeignClient;

 <span class="hljs-variable">@GetMapping</span>(<span class="hljs-string">&quot;feign/&#123;id&#125;&quot;</span>)
 public User userFeign(<span class="hljs-variable">@PathVariable</span>(<span class="hljs-string">&quot;id&quot;</span>) Integer id)&#123;
     <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">userFeignClient</span><span class="hljs-selector-class">.userFeign</span>(id);
 &#125;
&#125;</code></pre>

</li>
</ol>
<h3 id="七-SpringCloud引入Zuul"><a href="#七-SpringCloud引入Zuul" class="headerlink" title="七.SpringCloud引入Zuul"></a>七.SpringCloud引入Zuul</h3><blockquote>
<p>Zuul是在云平台上提供动态路由,监控,弹性,安全等边缘服务的框架。Zuul相当于是设备和Netflix流应用的 Web 网站后端所有请求的前门。Zuul和Eureka进行整合,将Zuul自身注册为Eureka服务治理下的应用,同时从Eureka中获得其他微服务的消息,也即以后的访问微服务都是通过Zuul跳转后获得</p>
<p>Zuul包含了对请求的路由和过滤两个最主要的功能:路由转发：接收一切外界请求，转发到后端的微服务上去。过滤器：在服务网关中可以完成一系列的横切功能，例如权限校验、限流以及监控等，这些都可以通过过滤器完成，路由转发也是通过过滤器实现的</p>
</blockquote>
<ol>
<li><p>新建项目在pom中加入依赖</p>
<pre><code class="hljs xml"> <span class="hljs-comment">&lt;!--  Zuul网关  --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-zuul<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-comment">&lt;!--  Eureka客户中心  --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre>
</li>
<li><p>编写yml配置文件</p>
<pre><code class="hljs yaml"><span class="hljs-attr">server:</span>
<span class="hljs-attr">port:</span> <span class="hljs-number">10080</span>
<span class="hljs-attr">spring:</span>
<span class="hljs-attr">application:</span>
<span class="hljs-comment">#服务的名称</span>
 <span class="hljs-attr">name:</span> <span class="hljs-string">zuul-service</span>
<span class="hljs-attr">eureka:</span>
<span class="hljs-attr">client:</span>
 <span class="hljs-attr">service-url:</span>
   <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://127.0.0.1:9090/eureka</span> <span class="hljs-comment">#指定注册中心地址</span>
<span class="hljs-attr">zuul:</span>
<span class="hljs-attr">retryable:</span> <span class="hljs-literal">true</span>
<span class="hljs-attr">ignored-services:</span>
 <span class="hljs-bullet">-</span> <span class="hljs-string">provider-service</span>  <span class="hljs-comment">#忽略整个服务，对外提供接口</span></code></pre>
</li>
<li><p>编写主启动类</p>
<pre><code class="hljs less"><span class="hljs-variable">@SpringBootApplication</span>
<span class="hljs-variable">@EnableZuulProxy</span>
public class ZuulMain10080 &#123;
 <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">static</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">main</span>(String[] args) &#123;
     <span class="hljs-selector-tag">SpringApplication</span><span class="hljs-selector-class">.run</span>(ZuulMain10080.class);
 &#125;
&#125;</code></pre>
</li>
<li><p>自定义过滤器</p>
<pre><code class="hljs java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoginFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ZuulFilter</span> </span>&#123;
<span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 返回字符串，代表过滤器的类型。包含以下4种：</span>
<span class="hljs-comment">     * pre：请求在被路由之前执行</span>
<span class="hljs-comment">     * routing：在路由请求时调用</span>
<span class="hljs-comment">     * post：在routing和error过滤器之后调用</span>
<span class="hljs-comment">     * error：处理请求时发生错误调用</span>
<span class="hljs-comment">    */</span>
 <span class="hljs-meta">@Override</span>
 <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">filterType</span><span class="hljs-params">()</span> </span>&#123;
     <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;pre&quot;</span>;
 &#125;
 <span class="hljs-comment">//通过返回的int值来定义过滤器的执行顺序，数字越小优先级越高。</span>
 <span class="hljs-meta">@Override</span>
 <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">filterOrder</span><span class="hljs-params">()</span> </span>&#123;
     <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
 &#125;
<span class="hljs-comment">//返回一个Boolean值，判断该过滤器是否需要执行。返回true执行，返回false不执行。</span>
 <span class="hljs-meta">@Override</span>
 <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">shouldFilter</span><span class="hljs-params">()</span> </span>&#123;
     <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
 &#125;
   <span class="hljs-comment">//过滤器的具体业务逻辑。</span>
 <span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">run</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ZuulException </span>&#123;
     <span class="hljs-comment">// 登录校验逻辑。</span>
     <span class="hljs-comment">// 1）获取Zuul提供的请求上下文对象</span>
     RequestContext ctx = RequestContext.getCurrentContext();
     <span class="hljs-comment">// 2) 从上下文中获取request对象</span>
     HttpServletRequest req = ctx.getRequest();
     <span class="hljs-comment">// 3) 从请求中获取token</span>
     String token = req.getParameter(<span class="hljs-string">&quot;access-token&quot;</span>);
     <span class="hljs-comment">// 4) 判断</span>
     <span class="hljs-keyword">if</span>(token == <span class="hljs-keyword">null</span> || <span class="hljs-string">&quot;&quot;</span>.equals(token.trim()))&#123;
         <span class="hljs-comment">// 没有token，登录校验失败，拦截</span>
         ctx.setSendZuulResponse(<span class="hljs-keyword">false</span>);
         <span class="hljs-comment">// 返回401状态码。也可以考虑重定向到登录页。</span>
         ctx.setResponseStatusCode(HttpStatus.UNAUTHORIZED.value());
     &#125;
     <span class="hljs-comment">// 校验通过，可以考虑把用户信息放入上下文，继续向后执行</span>
     <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
 &#125;
&#125;</code></pre>

</li>
</ol>
<h3 id="八-SpringCloud-Config"><a href="#八-SpringCloud-Config" class="headerlink" title="八.SpringCloud Config"></a>八.SpringCloud Config</h3><blockquote>
<p>随着业务的扩展，我们的服务会越来越多，越来越多。每个服务都有自己的配置文件。既然是配置文件，给我们配置的东西，那难免会有些改动的。</p>
<p>Spring Cloud Config项目是一个解决分布式系统的配置管理方案。它包含了Client和Server两个部分，server提供配置文件的存储、以接口的形式将配置文件的内容提供出去，client通过接口获取数据、并依据此数据初始化自己的应用。</p>
<p>简单来说，使用Spring Cloud Config就是将配置文件放到统一的位置管理(比如GitHub)，客户端通过接口去获取这些配置文件。在GitHub上修改了某个配置文件，应用加载的就是修改后的配置文件</p>
</blockquote>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/yangwentao-ywt.github.io/2020/08/21/SpringMVC%E6%A1%86%E6%9E%B6%E2%80%94SpringMVC%E6%8B%93%E5%B1%95/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile"></span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/yangwentao-ywt.github.io/2020/08/21/SpringBoot%E6%A1%86%E6%9E%B6%E2%80%94%E5%88%9D%E5%A7%8BSpringBoot/">
                        <span class="hidden-mobile"></span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
    

    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/yangwentao-ywt.github.io/js/debouncer.js" ></script>
<script  src="/yangwentao-ywt.github.io/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/yangwentao-ywt.github.io/js/lazyload.js" ></script>
  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/yangwentao-ywt.github.io/js/clipboard-use.js" ></script>







  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '#post-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/yangwentao-ywt.github.io/js/local-search.js" ></script>
  <script>
    var path = "/yangwentao-ywt.github.io/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>




















</body>
</html>
